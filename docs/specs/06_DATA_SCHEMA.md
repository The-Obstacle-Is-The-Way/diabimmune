# 06: Data Schema (Ironclad)

This spec defines the **exact on-disk schemas** used by this project. If these invariants do not hold, stop and fix the data pipeline before modeling.

---

## Raw Inputs (Source Of Truth)

### `data/raw/DIABIMMUNE_Karelia_metadata.RData`

- R object key: `metadata`
- Expected shape: `1946 × 59` (sample records × columns)
- Expected unique subjects: `222` (`subjectID`)
- Key columns used by this project:
  - `subjectID` (string; infant ID)
  - `SampleID` (string; matches OTU table sample columns)
  - `collection_month` (int-like)
  - `age_at_collection` (int-like; days)
  - `country` (`FIN|EST|RUS`)
  - `gender`
  - `read_count_16S` (numeric; >0 indicates 16S sample)
  - `allergy_milk`, `allergy_egg`, `allergy_peanut` (subject-level outcome repeated across rows; may be missing)

### `data/raw/diabimmune_karelia_16s_otu_table.txt`

- TSV file
- Header:
  - first column name: `sample` (row labels)
  - remaining columns: **1,584** sample IDs as strings (must match 16S `SampleID` values)
- Rows:
  - includes 2,005 OTU rows where the row label ends with `|<int>` (Greengenes OTU ID)
  - other rows (e.g., `k__Bacteria`) are aggregated/taxonomic rollups and are ignored

---

## Primary Processed Dataset (Food Allergy Only, 16S)

Generated by `scripts/prepare_16s_dataset.py` into `data/processed/16s/`.

### `data/processed/16s/samples_food_allergy.csv`

- Rows: **1,450** labeled 16S samples (excludes subjects with fully-missing food-allergy outcomes)
- Columns:
  - `sample_id`: `str` (unique; matches OTU table columns)
  - `subject_id`: `str` (repeats; used for grouping)
  - `collection_month`: `int`
  - `age_days`: `int`
  - `country`: `str` in `{FIN, EST, RUS}`
  - `gender`: `str`
  - `label_food`: `int` in `{0, 1}` (subject-level, propagated to each sample)

Invariants:
- `sample_id` is unique
- `label_food` is constant within each `subject_id`

### `data/processed/16s/otus_greengenes_ids.csv`

- Rows: **2,005**
- Columns:
  - `otu_id`: `int` (unique; sorted ascending)
  - `taxonomy`: `str` (original row label)

### `data/processed/16s/otu_counts.npz`

Arrays:
- `counts`: `(1450, 2005)` `int32`
- `sample_id`: `(1450,)` string array
- `otu_id`: `(2005,)` `int32`

Alignment invariants:
- `sample_id` equals `samples_food_allergy.csv.sample_id` row-for-row
- `otu_id` equals `otus_greengenes_ids.csv.otu_id` row-for-row
- `counts[i, j]` is the OTU count for `sample_id[i]` and `otu_id[j]`

### `data/processed/16s/dataset_manifest.json`

Contains:
- source file paths + sha256
- label definition + missingness handling
- counts (samples/subjects/OTUs) and country breakdown

---

## Legacy Processed Dataset (HuggingFace Subset)

Generated by `scripts/prepare_hf_legacy.py` into `data/processed/hf_legacy/`.

These artifacts are intentionally **not** used for “food allergy only” experiments.
