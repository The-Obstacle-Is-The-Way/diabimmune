# 02: Data Pipeline

## Goal

Create deterministic, validated artifacts for modeling:

1) **Primary dataset**: full **16S OTU table** + **food-allergy-only** labels
2) **Legacy dataset (optional)**: HuggingFace embeddings subset for quick baselines

---

## Primary: 16S OTU Dataset (Food Allergy Only)

### Inputs (source of truth)

- `data/raw/DIABIMMUNE_Karelia_metadata.RData`
  - Columns used: `subjectID`, `SampleID`, `collection_month`, `age_at_collection`, `country`, `gender`,
    `read_count_16S`, and `allergy_milk|allergy_egg|allergy_peanut`
- `data/raw/diabimmune_karelia_16s_otu_table.txt`
  - Header columns are `SampleID` values (1,584 samples)
  - Greengenes OTU IDs appear as the final `|<int>` segment in OTU row labels (2,005 OTUs)

### Outputs

Generated by `scripts/prepare_16s_dataset.py`:

- `data/processed/16s/samples_food_allergy.csv`
  - One row per labeled 16S sample
  - Columns: `sample_id,subject_id,collection_month,age_days,country,gender,label_food`
- `data/processed/16s/otus_greengenes_ids.csv`
  - Columns: `otu_id,taxonomy`
- `data/processed/16s/otu_counts.npz`
  - `counts`: `(n_samples, 2005)` int32 OTU counts aligned to `samples_food_allergy.csv`
  - `sample_id`: `(n_samples,)` sample IDs (strings)
  - `otu_id`: `(2005,)` Greengenes IDs (int32)
- `data/processed/16s/dataset_manifest.json`

### Label definition (strict)

Food allergy is **subject-level** and propagated to all samples:

```python
label_food = allergy_milk | allergy_egg | allergy_peanut
```

Missing handling:
- If a subject has **no observed values** for these three columns (all missing), exclude that subjectâ€™s samples.

### Build command

```bash
uv run python3 scripts/prepare_16s_dataset.py --force
```

---

## Legacy: HuggingFace Embeddings Subset (DEPRECATED)

**Status**: Moved to `_reference/hf_legacy/` (untracked). Do not use for "food allergy only" experiments.

This subset existed for back-compat with the earlier HF investigation but is now deprecated.

### Legacy artifacts (if present locally in `_reference/hf_legacy/`)

- `unified_samples.csv`
- `microbiome_embeddings_100d.h5`
- `srs_to_subject_mapping.csv`
- `dataset_manifest.json`

### Why deprecated

- Upstream HuggingFace Month_* structure is broken (not reliable collection month).
- Upstream label is `any(allergy_*) | totalige_high` (not food-only).
- Embedding provenance is unclear (unknown model/method).
- Only 785 samples (WGS-keyed subset), not full 1,584 16S samples.
