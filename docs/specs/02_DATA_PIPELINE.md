# 02: Data Pipeline

## Goal

Create deterministic, validated artifacts for modeling:

1) **Primary dataset**: full **16S OTU table** + **food-allergy-only** labels
2) **Legacy dataset (optional)**: HuggingFace embeddings subset for quick baselines

---

## Primary: 16S OTU Dataset (Food Allergy Only)

### Inputs (source of truth)

- `data/raw/DIABIMMUNE_Karelia_metadata.RData`
  - Columns used: `subjectID`, `SampleID`, `collection_month`, `age_at_collection`, `country`, `gender`,
    `read_count_16S`, and `allergy_milk|allergy_egg|allergy_peanut`
- `data/raw/diabimmune_karelia_16s_otu_table.txt`
  - Header columns are `SampleID` values (1,584 samples)
  - Greengenes OTU IDs appear as the final `|<int>` segment in OTU row labels (2,005 OTUs)

### Outputs

Generated by `scripts/prepare_16s_dataset.py`:

- `data/processed/16s/samples_food_allergy.csv`
  - One row per labeled 16S sample
  - Columns: `sample_id,subject_id,collection_month,age_days,country,gender,label_food`
- `data/processed/16s/otus_greengenes_ids.csv`
  - Columns: `otu_id,taxonomy`
- `data/processed/16s/otu_counts.npz`
  - `counts`: `(n_samples, 2005)` int32 OTU counts aligned to `samples_food_allergy.csv`
  - `sample_id`: `(n_samples,)` sample IDs (strings)
  - `otu_id`: `(2005,)` Greengenes IDs (int32)
- `data/processed/16s/dataset_manifest.json`

### Label definition (strict)

Food allergy is **subject-level** and propagated to all samples:

```python
label_food = allergy_milk | allergy_egg | allergy_peanut
```

Missing handling:
- If a subject has **no observed values** for these three columns (all missing), exclude that subject’s samples.

### Build command

```bash
uv run python3 scripts/prepare_16s_dataset.py --force
```

---

## Track A: HuggingFace Embeddings Subset (Baseline)

**Status**: Active baseline dataset for quick modeling (WGS-keyed subset; not the full 16S cohort).

### Artifacts (as tracked in this repo)

Embeddings (from HuggingFace):
- `data/processed/hf_legacy/microbiome_embeddings_100d.h5` — 785 samples, 100-dim float32 vectors keyed by SRS ID

Corrected metadata (for food-allergy-only labels + month files):
- `data/processed/longitudinal_wgs_subset/Month_*.csv` — 35 files, 785 samples total
  - Columns: `sid, patient_id, country, label, allergen_class`

Reference/traceability (do not use the label column here for food-only experiments):
- `data/processed/hf_legacy/unified_samples.csv`
- `data/processed/hf_legacy/srs_to_subject_mapping.csv`
- `data/processed/hf_legacy/dataset_manifest.json`

### Known limitations / gotchas

- This is a **785-sample WGS-keyed subset**, not the full 1,584-sample 16S cohort.
- The original HF dataset’s Month_* organization and labels are not reliable for “food allergy only”; use `longitudinal_wgs_subset/Month_*.csv` for labels and months.
- Upstream embedding generation is not fully documented; treat embeddings as a black-box representation unless regenerated.
